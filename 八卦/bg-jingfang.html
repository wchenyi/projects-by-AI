<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¬æˆ¿å…­åå››å¦ - å…¨èƒ½è®­ç»ƒç‰ˆ</title>
    <style>
        /* --- CSS å˜é‡ (ä¸»é¢˜) --- */
        :root {
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent: #c0392b; /* çº¢è‰²ï¼šä¸–çˆ»/ç« */
            --highlight: #2980b9; /* è“è‰²ï¼šé«˜äº® */
            --border-color: #ecf0f1;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            
            /* äº”è¡Œé¢œè‰² */
            --metal: #f1c40f; /* é‡‘ (ç”¨æš—é»„ä»£æ›¿ç™½ä»¥é€‚åº”ç™½åº•) */
            --wood: #27ae60;  /* æœ¨ */
            --water: #2980b9; /* æ°´ */
            --fire: #c0392b;  /* ç« */
            --earth: #95a5a6; /* åœŸ */
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-main: #ecf0f1;
            --text-sub: #bdc3c7;
            --border-color: #444;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --metal: #f1c40f; 
        }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 15px 20px;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        h1 { margin: 0; font-size: 1.1rem; }
        
        button { cursor: pointer; border: none; outline: none; font-family: inherit; }
        
        .theme-btn {
            background: transparent; font-size: 1.2rem; color: var(--text-main);
        }

        /* --- è§†å›¾åˆ‡æ¢ --- */
        .view-section {
            display: none;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }
        .view-section.active { display: block; animation: fadeUp 0.3s ease; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- é¦–é¡µ --- */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        .menu-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .menu-card:hover { transform: translateY(-5px); }
        .menu-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .menu-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }

        /* --- é€šç”¨ï¼šå¦è±¡è¡Œæ ·å¼ (æ ¸å¿ƒéƒ¨åˆ†) --- */
        .hex-row {
            display: flex;
            align-items: center;
            height: 30px; /* è¡Œé«˜ */
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        
        /* å·¦ä¾§ï¼šå…­äº²ä¸åœ°æ”¯ */
        .hex-info-left {
            width: 90px;
            text-align: right;
            padding-right: 10px;
            font-size: 0.8rem;
            color: var(--text-sub);
            display: flex;
            justify-content: flex-end;
            gap: 5px;
        }
        
        /* ä¸­é—´ï¼šé˜´é˜³çˆ»ç”» */
        .hex-line-visual {
            width: 100px;
            height: 100%;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .line-shape {
            width: 100%;
            height: 12px;
            border-radius: 2px;
        }
        .yang { background-color: var(--text-main); }
        .yin {
            display: flex; justify-content: space-between;
        }
        .yin::before, .yin::after {
            content: ''; display: block; width: 42%; height: 100%;
            background-color: var(--text-main); border-radius: 2px;
        }

        /* å˜è‰²é€»è¾‘ï¼šä¸–çˆ»çº¢è‰²ï¼Œåº”çˆ»ç°è‰² */
        .is-shi .line-shape, .is-shi .yin::before, .is-shi .yin::after { background-color: var(--accent); }
        .is-ying .line-shape, .is-ying .yin::before, .is-ying .yin::after { opacity: 0.6; }

        /* å³ä¾§ï¼šä¸–åº”æ ‡è®° */
        .hex-info-right {
            width: 40px;
            padding-left: 10px;
            font-weight: bold;
            font-size: 0.85rem;
        }
        .text-shi { color: var(--accent); }
        .text-ying { color: var(--text-sub); }

        /* äº”è¡Œç€è‰² helper */
        .c-metal { color: #d4ac0d; } /* é‡‘ */
        .c-wood { color: #27ae60; } /* æœ¨ */
        .c-water { color: #2980b9; } /* æ°´ */
        .c-fire { color: #c0392b; } /* ç« */
        .c-earth { color: #7f8c8d; } /* åœŸ */

        /* --- è®­ç»ƒæ¨¡å¼ --- */
        .train-area {
            background: var(--card-bg);
            padding: 30px 10px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* è®­ç»ƒæ—¶ï¼Œæœªæ­æ™“å‰éšè—ä¸¤ä¾§ä¿¡æ¯ */
        .hidden-mode .hex-info-left, 
        .hidden-mode .hex-info-right { visibility: hidden; }

        .answer-panel {
            margin-top: 20px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .answer-panel.visible { opacity: 1; }

        .btn-group { margin-top: 20px; display: flex; gap: 15px; }
        .btn {
            padding: 10px 25px; border-radius: 6px; font-weight: bold; transition: opacity 0.2s;
        }
        .btn-primary { background: var(--text-main); color: var(--card-bg); }
        .btn-outline { border: 1px solid var(--text-main); background: transparent; color: var(--text-main); }
        .btn:active { opacity: 0.7; }

        /* --- å­¦ä¹ æ¨¡å¼ --- */
        .nav-header { display: flex; align-items: center; margin-bottom: 20px; color: var(--text-sub); cursor: pointer; }
        .nav-header:hover { color: var(--text-main); }
        
        .palace-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4åˆ— */
            gap: 15px;
        }
        @media(max-width: 600px) { .palace-grid { grid-template-columns: repeat(2, 1fr); } }

        .palace-select-card {
            background: var(--card-bg);
            padding: 20px; border-radius: 8px; text-align: center;
            box-shadow: var(--shadow); cursor: pointer;
        }
        .palace-select-card:hover { background: var(--border-color); }

        .detail-list {
            display: flex; flex-direction: column; gap: 20px;
        }
        
        .detail-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .detail-header {
            width: 100%; border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .detail-name { font-size: 1.1rem; font-weight: bold; }
        .detail-pos { font-size: 0.9rem; color: var(--text-sub); }

    </style>
</head>
<body>

<header>
    <h1>äº¬æˆ¿å…«å®«ç ”ä¹ </h1>
    <button class="theme-btn" onclick="toggleTheme()">â—‘</button>
</header>

<div id="view-home" class="view-section active">
    <div class="menu-grid">
        <div class="menu-card" onclick="startTraining()">
            <span class="menu-icon">âš¡</span>
            <div class="menu-title">éšæœºè®­ç»ƒ</div>
            <div style="color:var(--text-sub)">éšå»ä¿¡æ¯ï¼Œå¿ƒç®—å®«ä½ä¸–åº”</div>
        </div>
        <div class="menu-card" onclick="startLearning()">
            <span class="menu-icon">ğŸ“–</span>
            <div class="menu-title">ç³»ç»Ÿå­¦ä¹ </div>
            <div style="color:var(--text-sub)">å…¨è§ˆå…«å®«ï¼Œè¯¦è§£çº³ç”²å…­äº²</div>
        </div>
    </div>
</div>

<div id="view-train" class="view-section">
    <div class="nav-header" onclick="goHome()">â† è¿”å›é¦–é¡µ</div>
    
    <div class="train-area" id="train-container">
        <div id="train-hex-visual" class="hidden-mode"></div>
        
        <div id="train-answer" class="answer-panel">
            <h2 id="ans-name" style="margin:5px 0">--</h2>
            <div id="ans-palace" style="color:var(--accent); font-weight:bold;">--</div>
            <div id="ans-desc" style="font-size:0.9rem; color:var(--text-sub); margin-top:5px;">--</div>
        </div>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="revealAnswer()">æ­æ™“ç­”æ¡ˆ</button>
            <button class="btn btn-outline" onclick="nextQuestion()">ä¸‹ä¸€å¦</button>
        </div>
    </div>
</div>

<div id="view-learn-list" class="view-section">
    <div class="nav-header" onclick="goHome()">â† è¿”å›é¦–é¡µ</div>
    <h3 style="text-align:center;">é€‰æ‹©å¦å®«</h3>
    <div class="palace-grid" id="palace-select-area">
        </div>
</div>

<div id="view-learn-detail" class="view-section">
    <div class="nav-header" onclick="switchView('view-learn-list')">â† è¿”å›å…«å®«åˆ—è¡¨</div>
    <h3 id="detail-title" style="text-align:center; margin-bottom:20px;">--</h3>
    <div class="detail-list" id="detail-area">
        </div>
</div>

<script>
    // ==========================================
    // 1. åŸºç¡€æ•°æ®å®šä¹‰ (The Data Layer)
    // ==========================================

    // å…«å¦åŸºç¡€äºŒè¿›åˆ¶ (åˆçˆ»->ä¸Šçˆ»)
    // 1=é˜³, 0=é˜´
    const TRIGRAMS = {
        "ä¹¾": [1,1,1], "å…‘": [1,1,0], "ç¦»": [1,0,1], "éœ‡": [1,0,0],
        "å·½": [0,1,1], "å": [0,1,0], "è‰®": [0,0,1], "å¤": [0,0,0]
    };

    // äº”è¡Œå±æ€§
    const WU_XING = {
        "ä¹¾": "é‡‘", "å…‘": "é‡‘", "ç¦»": "ç«", "éœ‡": "æœ¨", "å·½": "æœ¨", "å": "æ°´", "è‰®": "åœŸ", "å¤": "åœŸ",
        "å­": "æ°´", "ä¸‘": "åœŸ", "å¯…": "æœ¨", "å¯": "æœ¨", "è¾°": "åœŸ", "å·³": "ç«",
        "åˆ": "ç«", "æœª": "åœŸ", "ç”³": "é‡‘", "é…‰": "é‡‘", "æˆŒ": "åœŸ", "äº¥": "æ°´"
    };

    // çº³ç”²æ­Œè¯€æ˜ å°„ (å†…å¦ä¸‰çˆ», å¤–å¦ä¸‰çˆ»)
    // ä¹¾é‡‘ç”²å­å¤–å£¬åˆ, åæ°´æˆŠå¯…å¤–æˆŠç”³, è‰®åœŸä¸™è¾°å¤–ä¸™æˆŒ, éœ‡æœ¨åºšå­å¤–åºšåˆ
    // å·½æœ¨è¾›ä¸‘å¤–è¾›æœª, ç¦»ç«å·±å¯å¤–å·±é…‰, å¤åœŸä¹™æœªå¤–ç™¸ä¸‘, å…‘é‡‘ä¸å·³å¤–ä¸äº¥
    const NA_JIA_MAP = {
        "ä¹¾": { inner: ["å­","å¯…","è¾°"], outer: ["åˆ","ç”³","æˆŒ"] },
        "å": { inner: ["å¯…","è¾°","åˆ"], outer: ["ç”³","æˆŒ","å­"] }, // åå¯…ç”³
        "è‰®": { inner: ["è¾°","åˆ","ç”³"], outer: ["æˆŒ","å­","å¯…"] }, // è‰®è¾°æˆŒ
        "éœ‡": { inner: ["å­","å¯…","è¾°"], outer: ["åˆ","ç”³","æˆŒ"] }, // éœ‡åºšå­åˆ (åŒä¹¾)
        "å·½": { inner: ["ä¸‘","äº¥","é…‰"], outer: ["æœª","å·³","å¯"] }, // å·½è¾›ä¸‘æœª (é˜´å¦é€†è¡Œ)
        "ç¦»": { inner: ["å¯","ä¸‘","äº¥"], outer: ["é…‰","æœª","å·³"] }, // ç¦»å·±å¯é…‰ (é˜´å¦é€†è¡Œ)
        "å¤": { inner: ["æœª","å·³","å¯"], outer: ["ä¸‘","äº¥","é…‰"] }, // å¤ä¹™æœªç™¸ä¸‘ (é˜´å¦é€†è¡Œ)
        "å…‘": { inner: ["å·³","å¯","ä¸‘"], outer: ["äº¥","é…‰","æœª"] }  // å…‘ä¸å·³äº¥ (é˜´å¦é€†è¡Œ)
    };

    // 64å¦åæŸ¥è¯¢è¡¨ (Key: 6ä½äºŒè¿›åˆ¶å­—ç¬¦ä¸²)
    const HEX_NAMES = {
        "111111":"ä¹¾ä¸ºå¤©", "011111":"å¤©é£å§¤", "001111":"å¤©å±±é", "000111":"å¤©åœ°å¦", "000011":"é£åœ°è§‚", "000001":"å±±åœ°å‰¥", "101001":"ç«åœ°æ™‹", "101111":"ç«å¤©å¤§æœ‰",
        "010010":"åä¸ºæ°´", "110010":"æ°´æ³½èŠ‚", "111010":"æ°´é›·å±¯", "111110":"æ°´ç«æ—¢æµ", "111100":"æ³½ç«é©", "111101":"é›·ç«ä¸°", "010101":"åœ°ç«æ˜å¤·", "010000":"åœ°æ°´å¸ˆ",
        "001001":"è‰®ä¸ºå±±", "101001":"å±±ç«è´²", "111001":"å±±å¤©å¤§ç•œ", "110001":"å±±æ³½æŸ", "110101":"ç«æ³½ç½", "110111":"å¤©æ³½å±¥", "011111":"é£æ³½ä¸­å­š", "011001":"é£å±±æ¸",
        "100100":"éœ‡ä¸ºé›·", "000100":"é›·åœ°è±«", "010100":"é›·æ°´è§£", "011100":"é›·é£æ’", "011000":"åœ°é£å‡", "011010":"æ°´é£äº•", "111010":"æ³½é£å¤§è¿‡", "111100":"æ³½é›·éš",
        "011011":"å·½ä¸ºé£", "111011":"é£å¤©å°ç•œ", "101011":"é£ç«å®¶äºº", "100011":"é£é›·ç›Š", "100111":"å¤©é›·æ— å¦„", "100101":"ç«é›·å™¬å—‘", "001101":"å±±é›·é¢", "001011":"å±±é£è›Š",
        "101101":"ç¦»ä¸ºç«", "001101":"ç«å±±æ—…", "011101":"ç«é£é¼", "010101":"ç«æ°´æœªæµ", "010001":"å±±æ°´è’™", "010011":"é£æ°´æ¶£", "111011":"å¤©æ°´è®¼", "111101":"å¤©ç«åŒäºº",
        "000000":"å¤ä¸ºåœ°", "100000":"åœ°é›·å¤", "110000":"åœ°æ³½ä¸´", "111000":"åœ°å¤©æ³°", "111100":"é›·å¤©å¤§å£®", "111110":"æ³½å¤©å¤¬", "010110":"æ°´å¤©éœ€", "010000":"æ°´åœ°æ¯”",
        "110110":"å…‘ä¸ºæ³½", "010110":"æ³½æ°´å›°", "000110":"æ³½åœ°èƒ", "001110":"æ³½å±±å’¸", "001010":"æ°´å±±è¹‡", "001000":"åœ°å±±è°¦", "111000":"é›·å±±å°è¿‡", "110010":"é›·æ³½å½’å¦¹"
    };

    let allHexagrams = []; // å­˜å‚¨ç”Ÿæˆçš„64å¦è¯¦ç»†æ•°æ®
    let currentQuizHex = null;

    // ==========================================
    // 2. æ ¸å¿ƒé€»è¾‘ (Calculation Logic)
    // ==========================================

    // è·å–ç”Ÿå…‹å…³ç³»
    function getRelation(palaceEl, lineEl) {
        const relations = {
            "åŒ": "å…„å¼Ÿ",
            "ç”Ÿæˆ‘": "çˆ¶æ¯",
            "æˆ‘ç”Ÿ": "å­å­™",
            "å…‹æˆ‘": "å®˜é¬¼",
            "æˆ‘å…‹": "å¦»è´¢"
        };
        
        if (palaceEl === lineEl) return "å…„å¼Ÿ";

        // äº”è¡Œç”Ÿå…‹è¡¨
        const cycles = {
            "é‡‘": { ç”Ÿ: "æ°´", å…‹: "æœ¨" },
            "æ°´": { ç”Ÿ: "æœ¨", å…‹: "ç«" },
            "æœ¨": { ç”Ÿ: "ç«", å…‹: "åœŸ" },
            "ç«": { ç”Ÿ: "åœŸ", å…‹: "é‡‘" },
            "åœŸ": { ç”Ÿ: "é‡‘", å…‹: "æ°´" }
        };

        if (cycles[lineEl].ç”Ÿ === palaceEl) return "çˆ¶æ¯"; // çº¿ç”Ÿå®« -> çˆ¶æ¯(é”™)ï¼Œå…¶å®æ˜¯ç”Ÿæˆ‘è€…çˆ¶æ¯ã€‚çº¿çš„äº”è¡Œ ç”Ÿ å®«çš„äº”è¡Œï¼Ÿä¸ï¼Œæ˜¯ çº¿ç”Ÿå®«(çº¿æ³„å®«æ°”)? ä¸å¯¹ã€‚
        // ä¿®æ­£é€»è¾‘ï¼š
        // ç”Ÿæˆ‘è€…çˆ¶æ¯ï¼šLine ç”Ÿ Palace -> Lineæ˜¯çˆ¶æ¯? ä¸ï¼Œæ˜¯ Line çš„äº”è¡Œ ç”Ÿ Palace çš„äº”è¡Œ -> Lineæ˜¯çˆ¶æ¯ã€‚ (Line=æ°´, Palace=æœ¨, æ°´ç”Ÿæœ¨, Lineæ˜¯çˆ¶æ¯)
        if (cycles[lineEl].ç”Ÿ === palaceEl) return "çˆ¶æ¯"; 
        
        // æˆ‘ç”Ÿè€…å­å­™ï¼šPalace ç”Ÿ Line
        if (cycles[palaceEl].ç”Ÿ === lineEl) return "å­å­™";
        
        // å…‹æˆ‘è€…å®˜é¬¼ï¼šLine å…‹ Palace
        if (cycles[lineEl].å…‹ === palaceEl) return "å®˜é¬¼";
        
        // æˆ‘å…‹è€…å¦»è´¢ï¼šPalace å…‹ Line
        if (cycles[palaceEl].å…‹ === lineEl) return "å¦»è´¢";

        return "æœªçŸ¥";
    }

    // æ ¹æ®ä¸‰çˆ»æ‰¾åˆ°å…«å¦å
    function getTrigramName(threeLines) {
        const key = threeLines.join(""); // e.g. "111"
        for (let name in TRIGRAMS) {
            if (TRIGRAMS[name].join("") === key) return name;
        }
        return "æœªçŸ¥";
    }

    // ç”Ÿæˆå®Œæ•´æ•°æ®
    function generateAllData() {
        const list = [];
        const palaceOrder = ["ä¹¾","å…‘","ç¦»","éœ‡","å·½","å","è‰®","å¤"];
        const positions = ["æœ¬å®«(å…­ä¸–)", "ä¸€ä¸–", "äºŒä¸–", "ä¸‰ä¸–", "å››ä¸–", "äº”ä¸–", "æ¸¸é­‚(å››ä¸–)", "å½’é­‚(ä¸‰ä¸–)"];

        palaceOrder.forEach(pName => {
            let lines = [...TRIGRAMS[pName]]; // ä¸‹å¦
            lines = lines.concat(TRIGRAMS[pName]); // ä¸Šå¦ (å…­çº¯å¦)
            
            // å˜çˆ»é€»è¾‘ helper
            const flip = (idx) => { lines[idx] = lines[idx]===1?0:1; };

            // 1. æœ¬å®«
            list.push(createHexObj(lines, pName, positions[0], 6));

            // 2. ä¸€ä¸–åˆ°äº”ä¸–
            for(let i=0; i<5; i++){
                flip(i);
                list.push(createHexObj(lines, pName, positions[i+1], i+1));
            }

            // 3. æ¸¸é­‚ (ç¬¬4çˆ»å˜) -> æ­¤æ—¶æ˜¯äº”ä¸–çŠ¶æ€(0-4å·²å˜), å˜å›3(ç¬¬å››çˆ»)
            flip(3); 
            list.push(createHexObj(lines, pName, positions[6], 4));

            // 4. å½’é­‚ (ä¸‹ä¸‰çˆ»å˜å›æœ¬å®«)
            let base = TRIGRAMS[pName];
            lines[0]=base[0]; lines[1]=base[1]; lines[2]=base[2];
            list.push(createHexObj(lines, pName, positions[7], 3));
        });
        return list;
    }

    function createHexObj(lines, palaceName, posName, shiIdx) {
        const key = lines.join("");
        const name = HEX_NAMES[key] || "æœªçŸ¥";
        const palaceEl = WU_XING[palaceName];

        // åˆ†å‰²ä¸Šä¸‹å¦
        const innerLines = lines.slice(0, 3);
        const outerLines = lines.slice(3, 6);
        const innerName = getTrigramName(innerLines);
        const outerName = getTrigramName(outerLines);

        // è®¡ç®—çº³ç”²åœ°æ”¯
        // æ³¨æ„ï¼šlines[0]æ˜¯åˆçˆ»ã€‚NA_JIA_MAP.inner[0]ä¹Ÿæ˜¯åˆçˆ»ã€‚
        const innerBranches = NA_JIA_MAP[innerName].inner;
        const outerBranches = NA_JIA_MAP[outerName].outer;
        const allBranches = [...innerBranches, ...outerBranches];

        // æ„å»ºæ¯ä¸€çˆ»çš„è¯¦æƒ…
        const lineDetails = lines.map((val, idx) => {
            const branch = allBranches[idx];
            const el = WU_XING[branch];
            const relation = getRelation(palaceEl, el);
            return {
                val: val, // 0 or 1
                branch: branch,
                element: el,
                relation: relation,
                isShi: (idx + 1) === shiIdx,
                isYing: (idx + 1) === ((shiIdx + 3 - 1) % 6 + 1)
            };
        });

        return {
            key, name, palaceName, palaceEl, posName, shiIdx, lineDetails
        };
    }

    // ==========================================
    // 3. è§†å›¾æ¸²æŸ“ (View Layer)
    // ==========================================

    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }

    function goHome() { switchView('view-home'); }

    // æ¸²æŸ“ï¼šå•ä¸ªå¦è±¡ (é€šç”¨ç»„ä»¶)
    // mode: 'simple' | 'full' (æ˜¾ç¤ºå…­äº²æ–‡å­—) | 'hidden' (è®­ç»ƒç”¨ï¼Œéšè—æ–‡å­—)
    function renderHexagram(container, hexData, mode) {
        let html = '';
        // å€’åºæ¸²æŸ“ï¼šDOMä¸Šç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸Šçˆ»(ç´¢å¼•5)ï¼Œæœ€ä¸‹é¢æ˜¯åˆçˆ»(ç´¢å¼•0)
        // ä½¿ç”¨ flex-direction: column æ­£å¸¸å¸ƒå±€ï¼Œæ•°æ®å€’åºå¾ªç¯å³å¯
        
        for(let i=5; i>=0; i--) {
            const line = hexData.lineDetails[i];
            const isShi = line.isShi ? 'is-shi' : '';
            const isYing = line.isYing ? 'is-ying' : '';
            
            // å·¦ä¾§æ–‡å­—
            let leftText = '';
            if (mode !== 'hidden') {
                leftText = `
                    <span>${line.relation}</span>
                    <span class="c-${getElClass(line.element)}">${line.branch}${line.element}</span>
                `;
            }

            // å³ä¾§æ–‡å­—
            let rightText = '';
            if (line.isShi) rightText = '<span class="text-shi">ä¸–</span>';
            else if (line.isYing) rightText = '<span class="text-ying">åº”</span>';
            
            if (mode === 'hidden') rightText = ''; // è®­ç»ƒæœªæ­æ™“å‰éšè—

            html += `
                <div class="hex-row ${isShi} ${isYing}">
                    <div class="hex-info-left">${leftText}</div>
                    <div class="hex-line-visual">
                        <div class="line-shape ${line.val===1?'yang':'yin'}"></div>
                    </div>
                    <div class="hex-info-right">${rightText}</div>
                </div>
            `;
        }
        container.innerHTML = html;
        // è®­ç»ƒæ¨¡å¼ä¸‹ï¼Œéœ€è¦æ ¹æ® class å†æ¬¡æ§åˆ¶æ˜¾éš
        if(mode === 'hidden') container.classList.add('hidden-mode');
        else container.classList.remove('hidden-mode');
    }

    function getElClass(elChar) {
        if(elChar==='é‡‘') return 'metal';
        if(elChar==='æœ¨') return 'wood';
        if(elChar==='æ°´') return 'water';
        if(elChar==='ç«') return 'fire';
        if(elChar==='åœŸ') return 'earth';
        return '';
    }

    // --- è®­ç»ƒæ¨¡å¼é€»è¾‘ ---
    function startTraining() {
        switchView('view-train');
        nextQuestion();
    }

    function nextQuestion() {
        document.getElementById('train-answer').classList.remove('visible');
        const idx = Math.floor(Math.random() * allHexagrams.length);
        currentQuizHex = allHexagrams[idx];
        
        const container = document.getElementById('train-hex-visual');
        renderHexagram(container, currentQuizHex, 'hidden');
    }

    function revealAnswer() {
        if(!currentQuizHex) return;
        const container = document.getElementById('train-hex-visual');
        // é‡æ–°æ¸²æŸ“ä¸º full æ¨¡å¼
        renderHexagram(container, currentQuizHex, 'full');
        
        document.getElementById('ans-name').innerText = currentQuizHex.name;
        document.getElementById('ans-palace').innerText = 
            `${currentQuizHex.palaceName}å®« (${currentQuizHex.palaceEl}) - ${currentQuizHex.posName}`;
        document.getElementById('ans-desc').innerText = "å…­äº²å·²æ ‡äºå·¦ä¾§ï¼Œä¸–åº”æ ‡äºå³ä¾§";
        document.getElementById('train-answer').classList.add('visible');
    }

    // --- å­¦ä¹ æ¨¡å¼é€»è¾‘ ---
    function startLearning() {
        const container = document.getElementById('palace-select-area');
        // åªæ¸²æŸ“ä¸€æ¬¡
        if(container.children.length === 0) {
            ["ä¹¾","å…‘","ç¦»","éœ‡","å·½","å","è‰®","å¤"].forEach(p => {
                const div = document.createElement('div');
                div.className = 'palace-select-card';
                div.innerHTML = `<div style="font-size:1.5rem;font-weight:bold;">${p}</div><div style="font-size:0.8rem;color:var(--text-sub)">${WU_XING[p]}å®«</div>`;
                div.onclick = () => showDetail(p);
                container.appendChild(div);
            });
        }
        switchView('view-learn-list');
    }

    function showDetail(pName) {
        const family = allHexagrams.filter(h => h.palaceName === pName);
        const container = document.getElementById('detail-area');
        container.innerHTML = '';
        
        document.getElementById('detail-title').innerText = `${pName}å®«å…«å¦è¯¦è§£ (${WU_XING[pName]})`;

        family.forEach(hex => {
            const card = document.createElement('div');
            card.className = 'detail-card';
            
            const header = `
                <div class="detail-header">
                    <span class="detail-name">${hex.name}</span>
                    <span class="detail-pos">${hex.posName}</span>
                </div>
            `;
            
            const body = document.createElement('div');
            // åœ¨å­¦ä¹ æ¨¡å¼ï¼Œç›´æ¥æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
            renderHexagram(body, hex, 'full');
            
            card.innerHTML = header;
            card.appendChild(body);
            container.appendChild(card);
        });

        switchView('view-learn-detail');
    }

    // --- ä¸»é¢˜åˆ‡æ¢ ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
    }

    // åˆå§‹åŒ–
    window.onload = function() {
        try {
            allHexagrams = generateAllData();
        } catch (e) {
            alert("æ•°æ®åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç æˆ–åˆ·æ–°é¡µé¢ã€‚");
            console.error(e);
        }
    };

</script>
</body>
</html>
