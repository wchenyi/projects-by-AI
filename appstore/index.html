<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>应用商店</title>
    <meta name="description" content="一个精美的应用商店网页，发现新应用，激发新灵感。">
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./src/img/logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script>
        // 修复深色模式切换的闪烁问题 (FOUC)
        // 此脚本必须放在 <head> 中，且在 <body> 之前
        (function() {
            try {
                const theme = localStorage.getItem('theme');
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else if (theme === 'light') {
                    document.documentElement.classList.remove('dark');
                }
                // 如果 localStorage 中没有设置，则不执行任何操作，使用系统默认或CSS默认（亮色）
            } catch (e) {
                console.error("Error applying initial theme:", e);
            }
        })();
    </script>

    <style>
        :root {
            --theme-color-rgb: 14, 165, 233; /* 默认主题色 (天空蓝) */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        html.dark body { background-color: #020617; }
        .backdrop-blur-lg { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        html.dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* 主题色系统 */
        .theme-bg-active { background-color: rgb(var(--theme-color-rgb)); }
        .theme-text { color: rgb(var(--theme-color-rgb)); }
        .theme-bg-subtle { background-color: rgba(var(--theme-color-rgb), 0.1); }
        .theme-border-subtle { border-color: rgba(var(--theme-color-rgb), 0.2); }
        .theme-gradient-subtle { background-image: linear-gradient(to top right, rgba(var(--theme-color-rgb), 0.05), rgba(var(--theme-color-rgb), 0.15)); }
        html.dark .theme-bg-subtle { background-color: rgba(var(--theme-color-rgb), 0.15); }
        html.dark .theme-gradient-subtle { background-image: linear-gradient(to top right, rgba(var(--theme-color-rgb), 0.1), rgba(var(--theme-color-rgb), 0.2)); }

        /* 卡片网格布局 (已优化) */
        .card-grid { display: grid; gap: 1.5rem; }
        .card-grid.large { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
        .card-grid.medium { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
        .card-grid.small { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        
        /* [修复] 解决只有一个大卡片时过度拉伸的问题 */
        .card-grid.large.single-large {
            grid-template-columns: minmax(320px, 520px);
        }

        @media (min-width: 1280px) { /* xl */
            .card-grid.medium { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
            .card-grid.small { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        }
        @media (max-width: 640px) { /* mobile */
            .card-grid { gap: 0.75rem; }
            .card-grid.medium { grid-template-columns: 1fr; }
            .card-grid.small { grid-template-columns: repeat(2, 1fr); }
            .card-grid.large.single-large { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="antialiased">

    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <aside id="sidebar" class="w-64 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg p-4 flex-col flex-shrink-0 fixed lg:relative h-full z-30 -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out border-r border-gray-200 dark:border-slate-800">
            <a href="#home" id="sidebar-logo-link" class="flex items-center gap-3 mb-6 px-2">
                <img id="site-logo" src="" alt="Site Logo" class="w-8 h-8 object-contain">
                <h1 id="site-name-sidebar" class="text-xl font-bold text-slate-800 dark:text-slate-200"></h1>
            </a>
            <nav id="category-nav" class="flex-1 space-y-1">
                <!-- 分类导航会由JS动态生成 -->
            </nav>
        </aside>

        <!-- 主内容区 -->
        <div id="main-scroll-area" class="flex-1 flex flex-col overflow-auto bg-white dark:bg-slate-950">
            <!-- 顶部栏 -->
            <header class="sticky top-0 z-20 bg-white/80 dark:bg-slate-950/80 backdrop-blur-lg flex items-center justify-between p-4 border-b border-gray-200 dark:border-slate-800 h-20">
                <div class="flex items-center gap-2">
                    <button id="menu-toggle" class="lg:hidden p-2 rounded-md text-slate-600 hover:bg-gray-200 dark:text-slate-400 dark:hover:bg-slate-800"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                    <div id="search-container" class="relative flex items-center">
                         <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <input type="text" id="search-input" placeholder="搜索应用..." class="w-full sm:w-48 md:w-64 lg:w-96 bg-gray-100 dark:bg-slate-800 border border-transparent focus:ring-2 focus:ring-[rgb(var(--theme-color-rgb))] focus:border-transparent rounded-lg py-2 pl-10 pr-4 transition-all duration-300">
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full text-slate-600 hover:bg-gray-200 dark:text-slate-400 dark:hover:bg-slate-800 transition-colors"><svg id="theme-icon-light" class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 2V4M12 20V22M4.92999 4.92999L6.34999 6.34999M17.65 17.65L19.07 19.07M2 12H4M20 12H22M4.92999 19.07L6.34999 17.65M17.65 6.34999L19.07 4.92999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg id="theme-icon-dark" class="w-6 h-6 hidden" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.75C5.79522 2.75 2.75 5.79522 2.75 12C2.75 18.2048 5.79522 21.25 12 21.25C16.8375 21.25 20.5005 18.2625 21.125 13.5C15.825 14.125 10.125 9.0875 10.5 3.5C11.0875 3.05 11.525 2.75 12 2.75Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                    <img src="https://placehold.co/40x40/6366f1/ffffff?text=U" alt="用户头像" class="w-10 h-10 rounded-full">
                </div>
            </header>

            <main id="main-content" class="p-4 sm:p-6 lg:p-8 space-y-10 flex-grow"></main>
            
            <footer id="main-footer" class="p-8 mt-10 border-t border-gray-200 dark:border-slate-800 text-center text-sm text-slate-500 dark:text-slate-400 space-y-2">
                <!-- 页脚内容由JS动态生成 -->
            </footer>
        </div>
    </div>

    <!-- 应用详情 Modal -->
    <div id="app-detail-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="modal-backdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div id="modal-content" class="relative z-50 w-full max-w-2xl max-h-[90vh] bg-gray-100/80 dark:bg-slate-800/80 backdrop-blur-lg rounded-2xl shadow-2xl flex flex-col overflow-hidden transition-transform duration-300 scale-95 opacity-0">
            <div class="flex-shrink-0 p-6 flex justify-between items-start border-b border-gray-200 dark:border-slate-700">
                <div class="flex items-start gap-5">
                    <img id="modal-app-icon" src="" alt="App Icon" class="w-20 h-20 object-contain rounded-xl shadow-md flex-shrink-0">
                    <div>
                        <h2 id="modal-app-name" class="text-3xl font-bold text-slate-800 dark:text-slate-200"></h2>
                        <div class="flex items-center gap-2 mt-2 text-yellow-400">
                            <span id="modal-app-rating" class="text-lg font-bold text-slate-800 dark:text-slate-200"></span>
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"/></svg>
                        </div>
                        <p id="modal-app-platform" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></p>
                    </div>
                </div>
                <button id="modal-close-btn" class="p-2 rounded-full text-slate-600 hover:bg-gray-300 dark:text-slate-400 dark:hover:bg-slate-700"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                <div><h3 class="font-bold text-lg text-slate-700 dark:text-slate-300 mb-2">简介</h3><p id="modal-app-desc" class="text-slate-600 dark:text-slate-400 text-sm"></p></div>
                <div><h3 class="font-bold text-lg text-slate-700 dark:text-slate-300 mb-2">特色介绍</h3><div id="modal-app-features" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"></div></div>
            </div>
            <div id="modal-download-links" class="flex-shrink-0 p-4 border-t border-gray-200 dark:border-slate-700 bg-white/30 dark:bg-slate-900/30 grid grid-cols-2 lg:grid-cols-4 gap-3"></div>
        </div>
    </div>

    <button id="back-to-top" class="fixed bottom-6 right-6 z-30 w-12 h-12 rounded-full bg-slate-800/50 dark:bg-white/20 text-white dark:text-slate-200 backdrop-blur-sm shadow-lg flex items-center justify-center opacity-0 translate-y-4 transition-all duration-300 hover:scale-110 hover:bg-slate-900 dark:hover:bg-white/30">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 19V5m0 0l-4 4m4-4l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>

    <script type="module">
        // ===================================================================================
        // 网站核心配置中心
        // ===================================================================================
        const CONFIG = {
            siteName: "应用商店",
            siteLogo: "./src/img/logo.png",
            defaultLogoSVG: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 7L12 12L22 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 12V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            footer: {
                creationYear: 2023,
                author: "Your Name",
                version: "4.1.0" // Version updated
            },
            disclaimer: `
                <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">必看</h3>
                <ul class="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                    <li>出于学习与交流目的设立本站，本站所有内容与本人无任何关联 ❗</li>
                    <li>本站不提供任何形式的下载，仅为公开信息的搬运及整理。所有跳转链接均来自互联网，本站无法保证其安全性与可用性。</li>
                    <li><strong>请您自觉遵守我国相关法律规定，利用本站提供的信息进行任何操作，所带来的一切后果由您本人承担。</strong></li>
                    <li>严禁在国内社交平台、公开场合传播本站，请低调使用。</li>
                    <li>所有软件请于下载后的24小时内删除，如果您喜欢，请支持正版。</li>
                </ul>
                <h3 class="text-2xl font-bold mt-10 mb-4 text-gray-800 dark:text-gray-200">相关法律条列</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">根据《计算机信息网络国际联网安全保护管理办法》规定，任何单位和个人不得利用国际联网制作、复制、查阅和传播煽动抗拒、破坏宪法和法律、行政法规实施的；煽动颠覆国家政权，推翻社会主义制度的；煽动分裂国家、破坏国家统一的等危害国家安全、泄露国家秘密的言论。</p>
            `,
            categories: [
                { id: 'home', name: '主页', icon: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, themeColor: '#6b7280', gradient: 'from-gray-500 to-gray-700' },
                { type: 'divider' },
                { id: 'windows', name: 'PC端', file: './apps/windows/data.js', dataKey: 'windowsApps', bannerText: 'Windows 微软', icon: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 5a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5z" stroke="currentColor" stroke-width="2"/><path d="M8 21h8m-4-4v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, themeColor: '#0ea5e9', gradient: 'from-sky-500 to-sky-700' },
                { id: 'apple', name: '苹果端', file: './apps/apple/data.js', dataKey: 'appleApps', bannerText: 'Apple 生态', icon: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15.225 3.525c-1.425 0-2.55 1.125-3.225 2.25-.825-1.5-2.325-2.25-3.825-2.25-2.475 0-4.725 2.025-4.725 5.175 0 3.375 2.925 6.375 5.925 8.325 1.2.75 2.55 1.575 2.85 1.575.3 0 1.65-.825 2.85-1.575 3-1.95 5.925-4.95 5.925-8.325 0-3.15-2.25-5.175-4.725-5.175z"/><path d="M15.225 3.525c.9-.075 1.875.3 2.625 1.2.75.9.975 2.1.75 3.15"/></svg>`, themeColor: '#334155', gradient: 'from-slate-600 to-slate-800' },
                { id: 'android', name: '安卓端', file: './apps/android/data.js', dataKey: 'androidApps', bannerText: 'Android 安卓', icon: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 10l.75-2.5M14 4h-4l-1 2M4 10h16v9a2 2 0 01-2 2H6a2 2 0 01-2-2v-9z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 7V6l1-2m9 3V6l-1-2m-3 0h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, themeColor: '#22c55e', gradient: 'from-green-500 to-emerald-600' },
                { id: 'linux', name: 'Linux', file: './apps/linux/data.js', dataKey: 'linuxApps', bannerText: 'Linux', icon: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.4 12.76a1 1 0 00-.8 0c-2 1-3.9 2.4-5.2 4.44a1 1 0 00.1 1.4 8.6 8.6 0 0011 0 1 1 0 00.2-1.4c-1.3-2.03-3.2-3.43-5.3-4.44z" stroke="currentColor" stroke-width="2"/><circle cx="15.5" cy="8.5" r="1.5" fill="currentColor"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><path d="M12 2a3.5 3.5 0 00-3.5 3.5V10h7V5.5A3.5 3.5 0 0012 2z" stroke="currentColor" stroke-width="2"/></svg>`, themeColor: '#f97316', gradient: 'from-orange-500 to-amber-600' },
                { type: 'divider' },
                { id: 'other', name: '其他', file: './apps/other/data.js', dataKey: 'otherApps', bannerText: '其他工具', icon: `<svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12a2 2 0 100-4 2 2 0 000 4zM6 12a2 2 0 100-4 2 2 0 000 4zm12 0a2 2 0 100-4 2 2 0 000 4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, themeColor: '#6366f1', gradient: 'from-indigo-500 to-violet-600' }
            ]
        };

        // ===================================================================================
        // 主应用逻辑
        // ===================================================================================
        const doc = document;
        const mainScrollArea = doc.getElementById('main-scroll-area');
        const mainContent = doc.getElementById('main-content');
        const categoryNav = doc.getElementById('category-nav');
        const searchInput = doc.getElementById('search-input');
        const backToTopBtn = doc.getElementById('back-to-top');

        let allAppsData = {};
        let allAppsList = [];
        let currentCategoryId = 'home';

        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '107, 114, 128';
        };

        const loadAllData = async () => {
            const dataPromises = CONFIG.categories.filter(cat => cat.file).map(cat =>
                import(cat.file).then(m => ({ id: cat.id, data: m[cat.dataKey] || [] })).catch(e => {
                    console.warn(`Could not load data for category '${cat.id}' from '${cat.file}':`, e);
                    return { id: cat.id, data: [] };
                })
            );
            const results = await Promise.all(dataPromises);
            results.forEach(result => {
                allAppsData[result.id] = result.data.map(app => ({ ...app, categoryId: result.id }));
                allAppsList.push(...allAppsData[result.id]);
            });
        };

        const renderPage = (categoryId, appsToRender = null) => {
            mainContent.innerHTML = '';
            const category = CONFIG.categories.find(c => c.id === categoryId);
            if (!category) return;

            doc.documentElement.style.setProperty('--theme-color-rgb', hexToRgb(category.themeColor));
            
            const bannerText = appsToRender ? `搜索: "${searchInput.value}"` : (categoryId === 'home' ? CONFIG.siteName : category.bannerText);
            mainContent.appendChild(createBanner(bannerText, category.gradient));

            if (categoryId === 'home' && !appsToRender) {
                renderHomePage();
            } else {
                renderAppPage(appsToRender || allAppsData[categoryId] || [], !!appsToRender);
            }
            mainScrollArea.scrollTop = 0;
        };
        
        const createBanner = (text, gradient) => {
            const banner = doc.createElement('div');
            banner.className = `w-full h-40 sm:h-48 md:h-56 p-8 rounded-2xl flex items-center justify-center text-white bg-gradient-to-br ${gradient} shadow-lg`;
            banner.innerHTML = `<h2 class="text-4xl md:text-5xl font-black">${text}</h2>`;
            return banner;
        };

        const renderHomePage = () => {
            const homeContainer = doc.createElement('div');
            homeContainer.className = 'bg-white dark:bg-slate-900 p-6 sm:p-8 rounded-2xl shadow-md';
            homeContainer.innerHTML = CONFIG.disclaimer;

            const navSection = doc.createElement('div');
            navSection.innerHTML = `<h3 class="text-2xl font-bold mt-10 mb-4 text-gray-800 dark:text-gray-200">分类导航</h3>`;
            const navGrid = doc.createElement('div');
            navGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
            
            CONFIG.categories.filter(c => c.id !== 'home' && c.type !=='divider').forEach(cat => {
                const card = doc.createElement('a');
                card.href = `#${cat.id}`; // [修复] 使用 hash 链接
                card.className = `nav-card-home flex items-center gap-4 p-4 rounded-xl shadow-sm transition-all hover:shadow-lg hover:-translate-y-1 bg-gray-50 dark:bg-slate-800`;
                card.innerHTML = `<div class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg text-white" style="background-color: ${cat.themeColor};">${cat.icon}</div><span class="font-semibold text-slate-700 dark:text-slate-300">${cat.name}</span>`;
                navGrid.appendChild(card);
            });

            navSection.appendChild(navGrid);
            homeContainer.appendChild(navSection);
            mainContent.appendChild(homeContainer);
        };

        const renderAppPage = (apps, isSearchResult = false) => {
            if (!apps || apps.length === 0) {
                mainContent.insertAdjacentHTML('beforeend', `<div class="text-center py-16"><p class="text-gray-500">${isSearchResult ? '没有找到相关应用。' : '这个分类下还没有应用。'}</p></div>`);
                return;
            }
            const appGroups = {
                large: apps.filter(app => app.size === 'large'),
                medium: apps.filter(app => app.size === 'medium'),
                small: apps.filter(app => app.size === 'small'),
            };
            const sectionTitles = { large: '推荐应用', medium: '常用软件', small: '更多工具' };

            Object.entries(appGroups).forEach(([size, appList]) => {
                if(appList.length > 0) {
                    if(!isSearchResult) mainContent.appendChild(createSectionTitle(sectionTitles[size]));
                    const grid = doc.createElement('div');
                    grid.className = `card-grid ${size}`;
                    // [修复] 解决单一大卡片拉伸问题
                    if (size === 'large' && appList.length === 1) {
                        grid.classList.add('single-large');
                    }
                    appList.forEach(app => grid.appendChild(createAppCard(app, isSearchResult)));
                    mainContent.appendChild(grid);
                }
            });
        };

        const createSectionTitle = (title) => {
            const titleEl = doc.createElement('h3');
            titleEl.className = 'text-2xl font-bold border-b-2 border-gray-200 dark:border-slate-800 pb-2 mb-6 text-slate-800 dark:text-slate-200';
            titleEl.textContent = title;
            return titleEl;
        };

        const createAppCard = (app, isSearchResult = false) => {
            const card = doc.createElement('div');
            card.className = 'app-card group cursor-pointer transition-all duration-300 rounded-2xl shadow-lg relative overflow-hidden';
            
            const categoryBadge = isSearchResult ? `<span class="absolute top-3 left-3 text-xs font-semibold text-white bg-indigo-500 px-2 py-0.5 rounded-full z-10">${CONFIG.categories.find(c=>c.id===app.categoryId)?.name || ''}</span>` : '';

            if (app.size === 'large') {
                const features = (app.features || []).slice(0, 2).map(f => `<div class="flex items-center gap-2 text-xs backdrop-blur-sm bg-white/20 rounded-full px-3 py-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg>${f}</div>`).join('');
                
                // [修复] 只显示官网和商店下载按钮
                const downloads = app.downloads || {};
                const dlButtonsHtml = [];
                const buttonConfig = [
                    { key: 'official', text: '官网' },
                    { key: 'appStore', text: '商店' }
                ];
                buttonConfig.forEach(btn => {
                    if (downloads[btn.key]) {
                        dlButtonsHtml.push(`<a href="${downloads[btn.key]}" target="_blank" rel="noopener noreferrer" class="text-xs font-semibold bg-white/20 backdrop-blur-sm rounded-full px-4 py-2 hover:bg-white/40 transition-colors" onclick="event.stopPropagation();">${btn.text}</a>`);
                    }
                });
                const dlButtons = dlButtonsHtml.join('');

                card.className += ` aspect-[16/10] flex flex-col justify-between p-4 text-white bg-slate-800`;
                card.innerHTML = `
                    <div style="background-image: url(${app.icon});" class="absolute inset-0 bg-cover bg-center opacity-20 blur-md scale-125"></div>
                    <div class="relative z-10 flex justify-between items-start">
                        <img src="${app.icon}" alt="${app.name} icon" class="w-20 h-20 object-contain rounded-xl bg-white/10 p-1.5 shadow-md">
                        <div class="flex flex-col items-end gap-2 text-right">
                             <div class="flex items-center gap-1.5 text-lg font-bold">
                                <span>${app.rating}</span>
                                <svg class="w-5 h-5 text-yellow-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21L16.54 13.97L22 9.24L14.81 8.63L12 2L9.19 8.63L2 9.24L7.46 13.97L5.82 21L12 17.27Z"/></svg>
                            </div>
                            <div class="flex flex-col items-end gap-2">${features}</div>
                        </div>
                    </div>
                    <div class="relative z-10 flex justify-between items-end">
                        <div>
                            <h4 class="font-bold text-xl">${app.name}</h4>
                            <p class="text-sm text-white/70">${app.description || app.category}</p>
                        </div>
                        <div class="flex gap-2">${dlButtons}</div>
                    </div>
                    ${categoryBadge}
                `;
            } else if (app.size === 'medium') {
                card.className += ' bg-white dark:bg-slate-800/50 p-4 flex flex-col justify-between hover:-translate-y-1';
                const primaryDownload = app.downloads?.official || app.downloads?.github || app.downloads?.appStore || app.downloads?.alternative;
                const downloadButton = primaryDownload ? `<a href="${primaryDownload}" target="_blank" rel="noopener noreferrer" class="w-full text-center mt-3 text-sm font-semibold rounded-lg px-4 py-2 theme-bg-active text-white shadow-sm hover:opacity-90 transition-opacity" onclick="event.stopPropagation();">点击下载</a>` : '';
                card.innerHTML = `
                    <div class="flex items-start gap-4">
                        <img src="${app.icon}" alt="${app.name} icon" class="w-12 h-12 object-contain rounded-lg flex-shrink-0">
                        <div class="overflow-hidden">
                            <h4 class="font-semibold text-slate-700 dark:text-slate-300 truncate">${app.name}</h4>
                            <p class="text-xs text-slate-500 dark:text-slate-400">${app.platform || app.category}</p>
                        </div>
                    </div>
                    ${downloadButton}
                    ${categoryBadge}
                `;
            } else { // small
                card.className += ' bg-white dark:bg-slate-800/50 hover:-translate-y-1 flex flex-col';
                const primaryDownload = app.downloads?.official || app.downloads?.github || app.downloads?.appStore || app.downloads?.alternative;
                const downloadButton = primaryDownload ? `<a href="${primaryDownload}" target="_blank" rel="noopener noreferrer" class="w-full text-center mt-2 text-xs font-semibold rounded-md px-2 py-1.5 theme-bg-subtle theme-text hover:opacity-80 transition-opacity" onclick="event.stopPropagation();">点击下载</a>` : '';
                card.innerHTML = `
                    <div class="flex-grow h-24 flex items-center justify-center rounded-t-2xl theme-gradient-subtle">
                        <img src="${app.icon}" alt="${app.name} icon" class="w-12 h-12 object-contain">
                    </div>
                    <div class="p-3 text-center">
                        <h4 class="font-semibold text-sm text-slate-700 dark:text-slate-300 truncate">${app.name}</h4>
                        ${downloadButton}
                    </div>
                    ${categoryBadge}
                `;
            }

            Object.entries(app).forEach(([key, value]) => { card.dataset[key] = typeof value === 'object' ? JSON.stringify(value) : value; });
            card.addEventListener('click', () => openModal(card));
            return card;
        };
        
        const renderNav = () => {
            CONFIG.categories.forEach(cat => {
                if (cat.type === 'divider') {
                    categoryNav.innerHTML += `<div class="py-2"><hr class="border-gray-200 dark:border-slate-800"></div>`;
                    return;
                }
                const link = doc.createElement('a');
                link.href = `#${cat.id}`; // [修复] 使用 hash 链接
                link.dataset.category = cat.id;
                link.className = 'nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-gray-200 dark:hover:bg-slate-800 transition-colors font-medium';
                link.innerHTML = `${cat.icon}<span>${cat.name}</span>`;
                categoryNav.appendChild(link);
            });
        };

        const renderFooter = () => {
            const footer = doc.getElementById('main-footer');
            const currentYear = new Date().getFullYear();
            const yearString = CONFIG.footer.creationYear === currentYear ? currentYear : `${CONFIG.footer.creationYear} - ${currentYear}`;
            footer.innerHTML = `
                <p>&copy; ${yearString} ❤️ ${CONFIG.footer.author}. All Rights Reserved.</p>
                <p>Version ${CONFIG.footer.version}</p>
            `;
        };
        
        // [修复] 使用 hash change 事件来控制页面切换
        const handleHashChange = () => {
            const categoryId = location.hash.substring(1) || 'home';
            currentCategoryId = categoryId;
            searchInput.value = '';
            renderPage(categoryId);
            updateNavActiveState();
            // 在移动端，切换页面后自动关闭侧边栏
            if (window.innerWidth < 1024) {
                doc.getElementById('sidebar').classList.add('-translate-x-full');
            }
        };

        const updateNavActiveState = () => {
            doc.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-white', 'shadow-md', 'theme-bg-active');
                if (link.dataset.category === currentCategoryId) {
                    link.classList.add('text-white', 'shadow-md', 'theme-bg-active');
                }
            });
        };
        
        const init = async () => {
            doc.title = CONFIG.siteName;
            doc.getElementById('site-name-sidebar').textContent = CONFIG.siteName;
            const logoImg = doc.getElementById('site-logo');
            logoImg.onerror = () => { logoImg.outerHTML = `<div class="w-8 h-8 text-blue-500">${CONFIG.defaultLogoSVG}</div>`; };
            logoImg.src = CONFIG.siteLogo;
            
            if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname.endsWith('.local'))) {
                try {
                    navigator.serviceWorker.register('./sw.js').catch(err => console.error('Service worker registration failed:', err));
                } catch (e) { console.error('An exception occurred during service worker registration:', e); }
            }

            renderNav();
            renderFooter();
            initTheme(); // [修复] 初始化主题
            await loadAllData();
            
            // [修复] 设置 hash change 监听器并立即触发一次以加载初始页面
            window.addEventListener('hashchange', handleHashChange);
            handleHashChange(); // Load initial page based on hash or default
        };

        // --- Event Listeners ---
        mainScrollArea.addEventListener('scroll', () => {
            backToTopBtn.classList.toggle('opacity-0', mainScrollArea.scrollTop <= 200);
            backToTopBtn.classList.toggle('translate-y-4', mainScrollArea.scrollTop <= 200);
        });
        backToTopBtn.addEventListener('click', () => mainScrollArea.scrollTo({ top: 0, behavior: 'smooth' }));

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (searchTerm) {
                const filteredApps = allAppsList.filter(app => 
                    app.name.toLowerCase().includes(searchTerm) || 
                    (app.description && app.description.toLowerCase().includes(searchTerm)) ||
                    (app.category && app.category.toLowerCase().includes(searchTerm))
                );
                renderPage(currentCategoryId, filteredApps);
            } else {
                renderPage(currentCategoryId);
            }
        });

        // --- [修复] 深色模式切换逻辑 ---
        const themeToggle = doc.getElementById('theme-toggle');
        const lightIcon = doc.getElementById('theme-icon-light');
        const darkIcon = doc.getElementById('theme-icon-dark');

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                doc.documentElement.classList.add('dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            } else {
                doc.documentElement.classList.remove('dark');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }
        };

        const initTheme = () => {
            let currentTheme = localStorage.getItem('theme');
            if (!currentTheme) {
                currentTheme = 'light'; // 默认设置为亮色主题
                localStorage.setItem('theme', currentTheme);
            }
            applyTheme(currentTheme);
        };
        
        themeToggle.addEventListener('click', () => {
            const newTheme = doc.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- 移动端侧边栏开关 ---
        const menuToggle = doc.getElementById('menu-toggle'), sidebar = doc.getElementById('sidebar');
        menuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('-translate-x-full'); });
        doc.addEventListener('click', (e) => { if (!sidebar.contains(e.target) && !menuToggle.contains(e.target) && !sidebar.classList.contains('-translate-x-full')) { sidebar.classList.add('-translate-x-full'); } });

        // --- Modal Logic ---
        const modal = doc.getElementById('app-detail-modal'), modalContent = doc.getElementById('modal-content'), modalBackdrop = doc.getElementById('modal-backdrop'), closeBtn = doc.getElementById('modal-close-btn'), modalAppName = doc.getElementById('modal-app-name'), modalAppIcon = doc.getElementById('modal-app-icon'), modalAppRating = doc.getElementById('modal-app-rating'), modalAppDesc = doc.getElementById('modal-app-desc'), modalAppFeatures = doc.getElementById('modal-app-features'), modalAppPlatform = doc.getElementById('modal-app-platform'), modalDownloadLinks = doc.getElementById('modal-download-links');
        const openModal = (card) => {
            const appData = card.dataset;
            modalAppName.textContent = appData.name;
            modalAppIcon.src = appData.icon;
            modalAppRating.textContent = appData.rating;
            modalAppDesc.textContent = appData.description;
            modalAppPlatform.textContent = `支持平台: ${appData.platform}`;
            
            modalAppFeatures.innerHTML = '';
            const features = JSON.parse(appData.features || '[]');
            features.forEach(feature => {
                const featureEl = doc.createElement('div');
                featureEl.className = 'flex items-center gap-2 bg-white/50 dark:bg-slate-700/50 p-2 rounded-lg text-slate-700 dark:text-slate-300';
                featureEl.innerHTML = `<svg class="w-4 h-4 text-green-500 flex-shrink-0" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span>${feature}</span>`;
                modalAppFeatures.appendChild(featureEl);
            });

            modalDownloadLinks.innerHTML = '';
            const downloads = JSON.parse(appData.downloads || '{}');
            const downloadTypes = [
                { key: 'appStore', text: '应用商店', icon: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v9m0 0l-3-3m3 3l3-3m-3 12a9 9 0 110-18 9 9 0 010 18z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, color: 'bg-blue-600 hover:bg-blue-700' },
                { key: 'github', text: 'Github', icon: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>`, color: 'bg-gray-800 hover:bg-gray-900 dark:bg-gray-600 dark:hover:bg-gray-700' },
                { key: 'official', text: '官网下载', icon: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.72M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.72-1.72" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, color: 'bg-green-600 hover:bg-green-700' },
                { key: 'alternative', text: '备用下载', icon: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5-5-5 5m5-5v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`, color: 'bg-gray-500 hover:bg-gray-600' },
            ];
            downloadTypes.forEach(type => {
                if (downloads[type.key]) {
                    const link = doc.createElement('a');
                    link.href = downloads[type.key];
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.className = `flex items-center justify-center gap-2 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg transform hover:-translate-y-0.5 ${type.color}`;
                    link.innerHTML = `${type.icon}<span>${type.text}</span>`;
                    modalDownloadLinks.appendChild(link);
                }
            });
            if(modalDownloadLinks.innerHTML === '') modalDownloadLinks.innerHTML = `<p class="text-center text-gray-500 col-span-full">暂无可用下载链接</p>`;

            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.add('opacity-100'); modalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
        };
        const closeModal = () => {
            modalContent.classList.add('scale-95', 'opacity-0');
            modal.classList.remove('opacity-100');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        closeBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);
        doc.addEventListener('keydown', (e) => e.key === 'Escape' && !modal.classList.contains('hidden') && closeModal());

        init();
    </script>
</body>
</html>
